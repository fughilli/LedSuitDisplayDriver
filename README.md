# LED Suit Raspberry Pi Component

This repo contains the C++ implementation of a SPI display driver that runs on
a Raspberry Pi. The driver uses the VideoCore library to capture image frames
from the Raspberry Pi GPU and samples them according to a specification provided
as a binary protocol buffer. The sampled pixel values are then serialized and
transmitted to an FPGA display controller over SPI.

The display driver is intended to be run alongside `projectM-pulseaudio` on the
Raspberry Pi, and thus also includes a control layer for interacting with
ProjectM. Because ProjectM is prone to falling into set points and because of
extreme spatial aliasing from the sampling scheme, there must be a mechanism for
automatically advancing the preset within ProjectM when the current output is
not particularly "visually interesting".

An estimator for this "visual interest" is implemented in
`visual_interest_processor.cc`. The output of this estimator is run through a
hysteretic filter and then thresholded to determine when to skip the preset.
All parameters of this feature are configurable on the command line, including
disabling the ProjectM interface entirely.

## Building

This project uses `bazel` to build for the Raspberry Pi and to run local tools.

First install [`bazel`](https://github.com/bazelbuild/bazel/releases). Then,
clone my fork of the [`rpi_bazel`](https://github.com/fughilli/rpi_bazel)
workspace. Into this workspace, clone this repository.

You will also need to configure the sysroot for your Raspberry Pi
cross-compilation environment. To do this, first make sure to install all of the
required dependencies onto the Raspberry Pi (execute these commands from the
Raspberry Pi command line e.g. over SSH):

```
sudo apt-get install libxdo-dev projectM-pulseaudio

```

You will also need to enable OpenGL support on the Raspberry Pi to get hardware
acceleration for ProjectM and access to the VideoCore API.

Then, execute these commands on your host machine from the `rpi_bazel` root
directory:

```
cd tools/workspace/rpi_bazel
./make_sysroot.py --user=[user] [ip addr]
```

Where `user` is the user account on- and `ip addr` is the IP
address of the Raspberry Pi. You will then need to modify
`tools/workspace/rpi_bazel/repository.bzl` to point the
`_raspberry_pi_attrs["sysroot"]` label at the archive generated by the previous
step. It should be named something of the form `YYYY-MM-DD-sysroot.tar.xz`.

Next, build the driver for Raspberry Pi with:

```
bazel build --config=rpi LedSuitDisplayDriver:led_driver
```

If all went well, this will produce a binary artefact at
`blaze-bin/LedSuitDisplayDriver/led_driver`. Copy both this artefact and the
mapping generated in the next step to the Raspberry Pi and run them with:

```
# If using the ProjectM interface
DISPLAY=:0 ./led_driver

# If not using the ProjectM interface
./led_driver --enable_projectm_controller=false
```

## Configuring Mappings

`mapping_generator.py` is a small PyGame script which can be used to configure
the display mapping.

Run this script as follows:

```
bazel run :mapping_generator -- --generate_file=$PWD/generate.py --export_file=$PWD/mapping.binaryproto
```

This will open a PyGame window which shows the mapping generated by the
`generate.py` script. `mapping_generator.py` implements a file watcher on
`--generate_file`, so any changes to the file will result in an update to the
PyGame window.

Each time the script is re-executed, the mapping description will be written to
`--export_file`.

## Putting it all Together

Convenience scripts are included to run an Xserver, projectM, and the LED driver
on a remote Raspberry Pi. These scripts are located in the `remote_scripts`
directory. Copy them to the remote Raspberry Pi and execute
`sudo ./run_projectm.sh`. Also included are configuration files for projectM
that set up the correct input device and graphics settings. These files are
located in the `remote_config` directory.
